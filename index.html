<!DOCTYPE HTML>
<html lang="en">
<head>
  <title>Music Globe</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

  <div id="container"></div>

  <div id="info">
    <strong>Based on <a href="http://www.chromeexperiments.com/globe">WebGL Globe</a></strong> <span class="bull">&bull;</span> Data from bandsintown API</a>
  </div>


  <div id="title">
    <div class="input-group">
      <input id="artistName" type="text" class="form-control" placeholder="Artist">
      <div class="input-group-btn">
        <button id="searchBtn" class="btn btn-primary" type="button">Search</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
        <ul class="dropdown-menu pull-right">
          <li><a href="#raw">Raw search on Bandsintown</a></li>
        </ul>
      </div>
    </div>


    <div id="infos">
      <h2 id="artist"> </h2>
      <ul id="top10" class="list-group"></ul>
    </div>

    <div id="artists" class="list-group"><div>

  </div>

  <script type="text/javascript" src="lib/Detector.js"></script>
  <script type="text/javascript" src="lib/three.min.js"></script>
  <script type="text/javascript" src="lib/Tween.js"></script>
  <script type="text/javascript" src="lib/jquery-2.1.0.min.js"></script>
  <script type="text/javascript" src="globe.js"></script>
  <script type="text/javascript">

    if(!Detector.webgl){
      Detector.addGetWebGLMessage();
    } else {

      var container = document.getElementById('container');
      var globe = new DAT.Globe(container);

      function fetchData(mbid, name, rawName) {
        // var url = 'http://api.bandsintown.com/artists/' + artist + '/events.json?api_version=2.0&app_id=YOUR_APP_ID&date=all';
        var url = 'http://api.bandsintown.com/artists/mbid_' + mbid + '/events.json?api_version=2.0&app_id=YOUR_APP_ID&date=all';
        if (rawName) {
          url = 'http://api.bandsintown.com/artists/' + rawName + '/events.json?api_version=2.0&app_id=YOUR_APP_ID&date=all';
        }

        $.get(url, {}, function (data) {
          console.log(data);
          var globeDataLL = [];
          var cities = {};
          // first pass
          for (var i = 0; i < data.length; i++) {
            var city = data[i].venue.city;
            if (!cities.hasOwnProperty(city)) {
              cities[city] = 0;
            }
            cities[data[i].venue.city] += 1;
          }

          var top = Object.keys(cities).map(function(c) { return {city: c, n: cities[c]}; }).sort(function (a, b) {
            return b.n - a.n;
          });
          if (top.length === 0 || top[0].n === 0) return;
          var scale = 1 / top[0].n;

          $('#top10').empty();
          var topHtml = '';
          for (var i = 0; i < 10 && i < top.length; i++) {
            topHtml += '<li class="list-group-item"> <span class="badge alert-success">' + top[i].n + '</span> ' + top[i].city + ' </li>';
          }

          $('#artist').html(name);
          $('#top10').append(topHtml);


          for (var i = 0; i < data.length; i++) {
          	var venue = data[i].venue;
          	globeDataLL = globeDataLL.concat([parseFloat(venue.latitude), parseFloat(venue.longitude), cities[venue.city] * scale]);
          }

          globe.addData(globeDataLL, {format: 'magnitude'});
          globe.createPoints();

          $('#artists').fadeOut(500, function () {
            $('#infos').fadeIn();
          });

        }, 'jsonp');
      }
    }

    function fetchArtists(query) {
      $('#infos').fadeOut();
      $('#artists').fadeOut();
      var url = 'http://musicbrainz.org/ws/2/artist/?query=artist:' + query + '&fmt=json&limit=15'
      $.get(url, {}, function (data) {
        data = data.artist;
        var suggest = "";
        for (var i = 0; i < 10 && i < data.length; i++) {
          var a = data[i];
          suggest += '<a href="javascript:fetchData(\'' + a.id + '\', \'' + a.name + '\');" class="list-group-item">' + a.name + '</a>';
        }
        $('#artists').html(suggest).fadeIn();
      });
    }

    function search() {
      var name = $("#artistName").val();
      fetchArtists(name);
      globe.reset();
    }

    // inputs
    var timer;
    $('#searchBtn').click(function () {
      search();
    });

    $('#artistName').keyup(function (e) {

      if (e.keyCode === 13) {
        search();
      } else {
        clearTimeout(timer);
        timer = setTimeout(search, 1000);
      }
    });

    $('#artistName').keydown(function () {
      clearTimeout(timer);
    });

    $('a[href="#raw"]').click(function () {
      var name = $("#artistName").val();
      fetchData(null, name, name);
    });

    globe.animate();

  </script>


  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
</body>

</html>
